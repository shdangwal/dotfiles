const{version:e}=chrome.runtime.getManifest();document.body.setAttribute("data-version",e);let t=null;chrome.storage.local.get(["queue"],(async({queue:a})=>{if(a){const{currentTabId:s,tabsCount:o}=await new Promise((e=>{chrome.runtime.sendMessage({cmd:"GET_TAB_ID",parameter:{}},(t=>{e(t)}))}));a.tabId=s,a.tabsCount=o,a.version=Number(e),t=new BroadcastChannel(`channel-${s}`),t.addEventListener("message",(e=>{const{id:a,cmd:s,data:o,response:n}=e.data;if("GET_ALL_STORAGE"!==s)"BG_FETCH"!==s?chrome.runtime.sendMessage({cmd:s,parameter:o},(e=>{n&&t.postMessage({id:a,data:e})})):chrome.runtime.sendMessage({cmd:s,parameter:o},(e=>{e.ok&&e.blobURL?fetch(e.blobURL).then((e=>{if(e.ok)return e.blob();t.postMessage({id:a,data:{ok:!1,statusText:`Fetch Error-${e.status}`}})})).then((e=>{t.postMessage({id:a,data:{ok:!0,content:e}})})).catch((e=>{t.postMessage({id:a,data:{ok:!1,statusText:e.name}})})).finally((()=>{URL.revokeObjectURL(e.blobURL)})):t.postMessage({id:a,data:e})}));else{const{storageKey:e}=o;chrome.storage.local.get([e],(s=>{0!==Object.keys(s).length&&(s=s[e]),n&&t.postMessage({id:a,data:s})}))}})),window.addEventListener("beforeunload",(e=>{t&&t.close()})),chrome.storage.local.remove(["queue"])}else a=null;if(new BroadcastChannel("fetchv-temporary-channel").postMessage(a?JSON.stringify(a):a),a)if("rec"!==a.type)chrome.storage.local.get(["tasks"],(({tasks:e})=>{e||(e=[]),e.push({tabId:a.tabId,url:a.url}),chrome.storage.local.set({tasks:e})}));else{let e=!1;chrome.runtime.onMessage.addListener((function(a,s,o){const{cmd:n,parameter:r}=a;if("REC_ON_DATA"===n){const{data:a}=r;return a.url?fetch(a.url).then((e=>e.blob())).then((e=>{URL.revokeObjectURL(a.url),a.content=e,t&&t.postMessage({id:n,data:a})})).catch((()=>{void 0!==a.onended&&(a.onended=!0,t&&t.postMessage({id:n,data:a}))})):t&&t.postMessage({id:n,data:a}),e||(e=!0),o(),!0}return"REC_STOP"===n?(e=!1,t&&t.postMessage({id:n}),o(),!0):"REC_ERROR"===n?(t&&t.postMessage({id:n,data:r}),o(),!0):void 0}))}}));