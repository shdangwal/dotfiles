importScripts("./js/options.js");let e=!1,t=1,r=!1;const o={},n=[],s=[];try{chrome.action.setBadgeTextColor({color:"#FFFFFF"}),chrome.action.setBadgeBackgroundColor({color:"#FF0000"})}catch(e){}const a=async e=>{if("getContexts"in chrome.runtime){const t=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[chrome.runtime.getURL(e)]});return Boolean(t.length)}{const t=await clients.matchAll();return await t.some((t=>t.url.endsWith(`/${e}`)))}},i=async()=>{if(!r)if("offscreen"in chrome){const e="offscreen.html";if(r=await a(e),r)return;try{await chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.BLOBS],justification:"Convert blob data to blob URL"}),r=!0}catch(e){r=!1}}else r=!1},c=async()=>{const e=await chrome.storage.local.get(),t=await chrome.tabs.query({});for(const r of t){const t=`storage${r.id}`,n=e[t];"object"==typeof n&&Object.keys(n).length&&(o[t]=n,delete e[t])}e.tasks&&delete e.tasks,e.queue&&delete e.queue;const r=Object.keys(e);r.length&&chrome.storage.local.remove(r)},m=()=>{const e=e=>{e?.size?.min&&(e.size.min=1024*e.size.min,e.size.min<0&&(e.size.min=0)),e?.size?.max&&(e.size.max=1024*e.size.max,e.size.max<0&&(e.size.max=0))};return new Promise((t=>{try{chrome.storage.sync.get(["options"]).then((r=>{if(void 0!==r.options){const e=r.options;for(let t in OPTION)void 0!==e[t]&&"lang"!==t&&(OPTION[t]=e[t])}e(OPTION),t()}))}catch(r){e(OPTION),t()}}))},d=(e,t)=>{let r=Object.keys(e).length;r=r>0?r.toString():"",chrome.action.setBadgeText({text:r,tabId:t})},l=e=>{chrome.declarativeNetRequest.getSessionRules((function(t){const r=[];for(const o of t)void 0!==o.condition.tabIds&&o.condition.tabIds.includes(e)&&r.push(o.id);r.length>0&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:r})}))},u=e=>new Promise((t=>{e?t(e):chrome.declarativeNetRequest.getSessionRules((function(e){let r=2;for(const t of e)r=Math.max(r,t.id);r++,t(r)}))})),f=()=>!!chrome.runtime.lastError&&(console.warn(chrome.runtime.lastError.message),!0),p=(e,t)=>{const r=s.findIndex((r=>r.source===e&&r.receiver===t));r>-1&&s.splice(r,1)},h=(e,t,r)=>{s.some((r=>r.source===e&&r.receiver===t))||s.push({source:e,receiver:t,mode:r})},g=e=>{const t=s.filter((t=>t.source===e||t.receiver===e));if(t.length)for(const r of t){const t=r.source===e?r.receiver:r.source,o="REC_STOP",n={};t===r.source&&(n.mode=r.mode),chrome.tabs.sendMessage(t,{cmd:o,parameter:n},(()=>{f()})),p(r.source,r.receiver)}};chrome.declarativeNetRequest.getSessionRules((async function(e){if(0===e.length)return;const t=await chrome.tabs.query({}),r=[];for(const e of t)r.includes(e.id)||r.push(e.id);const o=[];for(const t of e){if(void 0===t.condition.tabIds)continue;t.condition.tabIds.some((e=>r.includes(e)))||o.includes(t.id)||o.push(t.id)}o.length>0&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:o})})),chrome.runtime.onConnect.addListener((function(r){"POPUP"===r.name&&(e=!0,r.onDisconnect.addListener((function(){e=!1,chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[t]})})))})),chrome.runtime.onMessage.addListener((function(e,t,s){const{cmd:a,parameter:c}=e;if("REC_ON_DATA"===a){const{recorderTab:e,data:r}=c;return chrome.tabs.sendMessage(e,{cmd:a,parameter:{data:r}},(()=>{f()})),r.onended&&p(t.tab.id,e),s(),!0}if("BG_FETCH"===a){let{url:e,headers:t,method:o}=c;return i().then((()=>{r?chrome.runtime.sendMessage({cmd:"OFFSCREEN_FETCH_DATA",parameter:{url:e,headers:t,method:o}},(e=>{!chrome.runtime.lastError&&e||(e={ok:!1,statusText:"Background Fetch Error"}),s(e)})):s({ok:!1,statusText:"Offscreen Error"})})),!0}if("GET_TAB_ID"===a)return chrome.tabs.query({}).then((e=>{const r=t.tab.id,o=e.length;s({currentTabId:r,tabsCount:o})})),!0;if("SET_RULES"===a){const{ruleObject:e,ruleId:t}=c;return u(t).then((t=>{try{e.id=t,chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[t],addRules:[e]},(function(){f(),s(t)}))}catch(e){s(0)}})),!0}if("REMOVE_RULES"===a){const{ruleId:e}=c;return chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[e]}),s(),!0}if("OPEN_INITIATOR"===a){const{initiator:e}=c;return chrome.tabs.create({url:e,index:t.tab.index+1}),s(""),!0}if("GET_ICON"===a)return s(t.tab.favIconUrl),!0;if("RESET_OPTIONS"===a){const{storageKey:e}=c;return m().then((()=>{if(!e)return void s();const t=o[e],r=[];for(const e in t){const o=t[e],n=new URL(o.url).hostname;n&&OPTION.domain.includes(n)&&r.push(e)}if(r.length>0){for(const e of r)delete t[e];0===Object.keys(t).length?(delete o[e],chrome.storage.local.remove([e],(()=>{s()}))):chrome.storage.local.set({[e]:t},(()=>{s()}))}else s()})),!0}if("TAB_ACTIVE"===a)return chrome.tabs.update(t.tab.id,{active:!0},(()=>{s()})),!0;if("OPEN_DOWNLOADS"===a)return chrome.tabs.create({url:"chrome://downloads/",index:t.tab.index+1}),s(),!0;if("REC_START"===a){const{targetTab:e,mode:r,quickStart:o}=c;return chrome.tabs.update(e,{active:!0}),chrome.tabs.sendMessage(e,{cmd:a,parameter:{tab:t.tab.id,mode:r,quickStart:o}},(()=>{f()||h(e,t.tab.id,r)})),s(),!0}if("REC_STOP"===a){const{tabId:e,mode:r}=c;return chrome.tabs.sendMessage(e,{cmd:a,parameter:{mode:r}},(()=>{f()&&"msr"===r&&chrome.tabs.sendMessage(t.tab.id,{cmd:a,parameter:{}})})),p(e,t.tab.id),s(),!0}if("REC_SPEED_UP"===a){const{targetTab:e,speed:t}=c;return chrome.tabs.sendMessage(e,{cmd:a,parameter:{speed:t}},(()=>{f()})),s(),!0}if("REC_RESTART"===a){const{tabId:e}=c;return chrome.tabs.sendMessage(e,{cmd:a,parameter:{}},(()=>{f()||h(e,t.tab.id,"msr")})),s(),!0}if("REC_ERROR"===a){const{tabId:e,fatal:t,message:r}=c;return chrome.tabs.sendMessage(e,{cmd:a,parameter:{fatal:t,message:r}},(()=>{f()})),s(),!0}if("REMOVE_ALL_FRAME_MODAL"===a)return chrome.tabs.sendMessage(t.tab.id,{cmd:a,parameter:{}}),s(),!0;if("INJECT_STORAGE_REGISTER"===a){const{documentId:e}=t;return e&&!n.includes(e)&&n.push(e),s(),!0}s()})),chrome.tabs.onRemoved.addListener((function(e){l(e);const t=`storage${e}`;chrome.storage.local.remove([t]),o[t]&&delete o[t],g(e)})),chrome.tabs.onUpdated.addListener((function(e,t,r){if("loading"===t.status&&t.url){const t=`storage${e}`;o[t]&&delete o[t],chrome.storage.local.remove([t],(()=>{d(o[t]||{},e)})),g(e)}})),async function(){await m(),await c();const t=(e,t)=>{e=e.toLowerCase();for(let r=0;r<t.length;r++)if(t[r].name.toLowerCase()===e)return t[r].value.toLowerCase();return null},r=(e,t)=>{let r={m3u8:"video/mp4",m3u:"video/mp4",mp4:"video/mp4","3gp":"video/3gpp",flv:"video/x-flv",mov:"video/quicktime",avi:"video/x-msvideo",wmv:"video/x-ms-wmv",webm:"video/webm",ogg:"video/ogg",ogv:"video/ogg",f4v:"video/x-f4v",acc:"application/vnd.americandynamics.acc",mkv:"video/x-matroska",rmvb:"application/vnd.rn-realmedia-vbr",m4s:"video/iso.segment",mp3:"audio/mpeg",wav:"audio/wav"};return r[e]?r[e]:t},s={},a=["youtube.com","globo.com"],i=["m3u8","m3u","mp4","3gp","flv","mov","avi","wmv","webm","f4v","acc","mkv","mp3","wav","ogg"],l=["range","content-length","content-type","accept-encoding","accept","accept-language"];chrome.webRequest.onBeforeSendHeaders.addListener((function(e){if(!e.initiator)return;if(0!==e.initiator.indexOf("http"))return;const t=e.requestHeaders;s[e.requestId]=t||{}}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["requestHeaders","extraHeaders"]),chrome.webRequest.onResponseStarted.addListener((async function(c){let{requestId:m,initiator:u,url:f,tabId:p,documentId:h,method:g,responseHeaders:v,statusCode:b}=c,O=[];if(s[m]&&(O=s[m],delete s[m]),O.some((e=>"x-original-request-id"===e.name.toLowerCase())))return;if(0!==f.indexOf("http"))return;if(!u)return;if(0!==u.indexOf("http"))return;const R=new URL(u).hostname;for(const e of a)if(R.endsWith(e))return;if(0===u.indexOf(OPTION.site))return;if(-1===p){if(!await new Promise((e=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0}).then((([t])=>{t&&t.url.includes(u)?(p=t.id,e(!0)):e(!1)}))})))return}if(v.length<1)return;if(b<200||b>300)return;const T=new URL(f).hostname;if(T){if((e=>{const t=["doppiocdn","adtng","afcdn","sacdnssedge"],r=e.split(".");r.pop();const o=r.length;if(o>0){const e=r[o-1];if(t.indexOf(e)>-1)return!0}return!1})(T))return;if(OPTION.domain.includes(T))return}let w=0,x=(e=>{let r=t("Content-Range",e);return r?(r=r.split(" "),2!==r.length?null:(r=r[1].split("/"),2!==r.length?null:(r[1]=parseInt(r[1]),r[1]?{chunk:r[0],total:r[1]}:null))):null})(v);w=x?x.total:(e=>{let r=t("Content-Length",e);return r?(r=parseInt(r),r<1?0:r):0})(v);let E=t("content-type",v);if(E){if(E.includes(";")){const e=E.split(";");for(let t of e)if(t=t.trim(),t){E=t;break}}}else{let{pathname:e}=new URL(f);if(e=e.toLowerCase(),"media"===c.type&&(e.endsWith(".mp4")&&(E="video/mp4"),e.endsWith(".webm")&&(E="video/webm")),"xmlhttprequest"===c.type&&e.endsWith(".m3u8")&&(E="application/vnd.apple.mpegurl"),!E)return}"xmlhttprequest"===c.type&&h&&n.includes(h)&&"GET"===g&&(e=>!!e.startsWith("text/")||!!["application/json","application/xml","application/javascript"].some((t=>e===t)))(E)&&(/google-analytics\.com|google\.com|googleadservices|doubleclick/.test(f)||await((e,t,r,o,n,s)=>new Promise((a=>{chrome.tabs.sendMessage(o,{cmd:"CHECK_TEXT_CONTENT",parameter:{url:e,headers:t,method:r,requestId:s}},{documentId:n},(e=>{chrome.runtime.lastError?a(!1):a(e)}))})))(f,O,g,p,h,m)&&(E="application/vnd.apple.mpegurl"));let I=(e=>{const{responseHeaders:r,url:o,type:n}=e;let s=null,a=t("content-disposition",r);if(a){a=a.split(";");for(let e=0;e<a.length;e++)if(a[e].indexOf("filename=")>-1){if(a[e]=a[e].replace(/filename=/i,"").replace(/\"/g,"").replace(/\'/g,"").replace(/(^\s*)|(\s*$)/g,""),s=a[e],s)return s;break}}return a=o.replace(/http:\/\//i,"").replace(/https:\/\//i,""),a=a.split("?"),a=a[0].split("/"),a.length<2?null:(a=a[a.length-1],a||"media"===n&&(a="undefined.mp4"),a||s)})(c);I||(I="no-filename");let y=((e,t)=>{if(e.includes("master.txt")&&0===t.indexOf("text/plain"))return"m3u8";let r=(e=>{let t=e.split(".");return t.length<2?null:t[t.length-1].toLowerCase()})(e);const o=["m3u8","m3u","mp4","webm","avi","ogg","flv","mkv","3gp","mp3"];let n={general:{"application/vnd.apple.mpegurl":["m3u8","m3u"],"application/x-mpegurl":["m3u8","m3u"],"application/vnd.americandynamics.acc":["acc"],"application/vnd.rn-realmedia-vbr":["rmvb"],"video/mp4":["mp4","m4s"],"video/3gpp":["3gp"],"video/3gpp2":["3gp2"],"video/x-flv":["flv"],"video/quicktime":["mov"],"video/x-msvideo":["avi"],"video/x-ms-wmv":["wmv"],"video/webm":["webm"],"video/ogg":["ogg","ogv"],"video/x-f4v":["f4v"],"video/x-matroska":["mkv"],"video/iso.segment":["m4s"],"audio/mpeg":["mp3"],"audio/wav":["wav"],"audio/ogg":["ogg"]},stream:{"application/octet-stream":o,"binary/octet-stream":o}};if(n.general[t]){if(!r)return n.general[t][0];let e=n.general[t].indexOf(r);return e<0?n.general[t][0]:n.general[t][e]}if(n.stream[t]){if(!r)return null;let e=n.stream[t].indexOf(r);return e<0?null:n.stream[t][e]}return o.includes(r)?r:null})(I,E);if(!y){if("xmlhttprequest"!==c.type||!x)return;if(!await((e,t)=>new Promise((r=>{const o=setTimeout((()=>{r(!1)}),2e3);chrome.tabs.sendMessage(t,{cmd:"CHECK_VIDEO_SRC",parameter:{url:e}},(e=>{if(chrome.runtime.lastError)return clearTimeout(o),void r(!1);clearTimeout(o),r("boolean"==typeof e&&e)}))})))(f,p))return;y="mp4"}if(i.indexOf(y)<0)return;let C=y;if("m3u8"!==y&&"m3u"!==y){if(!w)return;if(OPTION.size.min&&w<OPTION.size.min)return;if(OPTION.size.max&&w>OPTION.size.max)return}else C="hls";const _=`storage${p}`;let P=o[_];if(P||(P={},o[_]=P),Object.keys(P).length>30)return;if(((e,t)=>{for(let r in t)if(t[r].url===e)return!0;return!1})(f,P))return void d(P,p);const S={};for(const e of O)l.includes(e.name.toLowerCase())||(S[e.name]=e.value);P[m]={storageKey:_,requestId:m,url:f,method:"POST"===g?"POST":"GET",format:y,contentType:r(y,E),name:I,size:w,headers:S,type:C},chrome.storage.local.set({[_]:P}),e&&chrome.runtime.sendMessage({cmd:"POPUP_APPEND_ITEMS",parameter:{tab:p,item:{[m]:P[m]}}},(()=>{chrome.runtime.lastError&&console.warn("POPUP closed")})),d(P,p)}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["responseHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener((function(e){e.url.startsWith("https://fetchv.net")&&console.log(e)}),{urls:["<all_urls>"],types:["main_frame"]},["requestHeaders","extraHeaders"])}();