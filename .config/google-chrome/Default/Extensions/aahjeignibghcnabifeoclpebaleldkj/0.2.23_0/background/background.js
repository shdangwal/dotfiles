function b(){[{id:"remove_duplicates",title:chrome.i18n.getMessage("remove_duplicate_tabs")},{id:"group_same_domain_tab",title:chrome.i18n.getMessage("group_same_domain_tab")},{id:"suspend_other_tabs",title:chrome.i18n.getMessage("suspend_other_tabs")},{id:"suspend_panel",title:chrome.i18n.getMessage("suspend_manager")},{id:"unGroup_all_tabs",title:chrome.i18n.getMessage("ungroup_all_tabs")}].forEach(e=>{chrome.contextMenus.create({id:e.id,title:e.title,contexts:["action"]})})}var g={remove_duplicates:w,group_same_domain_tab:T,suspend_other_tabs:y,suspend_panel:()=>chrome.tabs.create({url:"chrome://discards/"}),unGroup_all_tabs:R};async function T(){let r=()=>e[Math.floor(Math.random()*9)],e=["blue","red","yellow","green","cyan","purple","pink","orange","grey"],t=await chrome.tabs.query({currentWindow:!0}),o=t.reduce((s,n)=>{let a=new URL(n.url).host;return s[a]??={},s[a][n.id]=n,s},{});for(let[s,n]of Object.entries(o)){let a=await chrome.tabs.group({tabIds:n});chrome.tabGroups.update(a,{collapsed:!1,title:s,color:e[r()]})}}async function w(){let r=await chrome.tabs.query({currentWindow:!0}),e=new Set;r.reduce((t,o)=>(t[o.url]?e.add(o.id):t[o.url]=o.id,t),{}),e.size!==0&&chrome.tabs.remove([...e])}function y(){chrome.tabs.query({currentWindow:!0}).then(r=>r.forEach(({active:e,id:t})=>e||chrome.tabs.discard(t))).catch(r=>console.error(r))}async function R(){let r=(await chrome.tabs.query({currentWindow:!0})).map(({id:e})=>e);await chrome.tabs.ungroup(r).catch(e=>console.error(e))}var c={TabGroupRules:"TabGroupRules"};function x({target:r}){r.result.createObjectStore(c.TabGroupRules,{keyPath:"id"})}function p(){return new Promise((r,e)=>{let t=indexedDB.open("tabVertikal",1);t.onupgradeneeded=x,t.onsuccess=()=>r(t.result),t.onerror=()=>e(t.error),t.onblocked=()=>console.warn("Pending until unblocked")})}async function i(){return new Promise((r,e)=>{p().then(t=>{let s=t.transaction(c.TabGroupRules,"readonly").objectStore(c.TabGroupRules).getAll();s.onsuccess=({target:n})=>r(n.result),s.onerror=n=>e(n),t.close()})})}async function f(){return new Promise((r,e)=>{p().then(t=>{let s=t.transaction(c.TabGroupRules,"readonly").objectStore(c.TabGroupRules).count();s.onsuccess=({target:n})=>r(n.result>=1),s.onerror=n=>e(n),t.close()})})}var u=class{constructor(){}async setTabGroupRules(){this.tabGroupRules=await i()}async groupAllUngroupTabs(){let e=await chrome.tabs.query({currentWindow:!0,groupId:-1});this.tabGroupRules=await i();for(let t of e)await new Promise(o=>setTimeout(o,1e3)),await this.addTabInGroup(t)}async applyTabGroup(e,t,o,s){let n=await chrome.tabGroups.query({title:o}),a=(await getStore("createdTabGroups")).createdTabGroups??{};async function d(){if(n.length!=0)chrome.tabs.group({tabIds:e,groupId:n[0].id});else try{let l=await chrome.tabs.group({tabIds:e});if(chrome.tabGroups.update(l,{collapsed:!1,title:o,color:t.color??"grey"}),a[o]||t.priority===0)return;a[o]=t.priority,setStore({createdTabGroups:a})}catch(l){console.warn(l)}}if(s===-1)return d();let m=(await chrome.tabGroups.get(s)).title;if(!a[m]||t.priority>a[m])return d()}_applyTabGroup=(e,t)=>this.applyTabGroup(this.tab.id,e,t,this.tab.groupId);top_domain(e,t){let o=this.url.host.lastIndexOf(".",this.url.host.lastIndexOf(".")-1)+1,s=this.url.host.slice(o),n=t.ctmGroupTitle;n||(n=e.length===0?s:e.includes(s)&&e[0]),(e.length===0||e.includes(s))&&this.pathSegment(t,n)}domain(e,t){(e.length===0||e.includes(this.url.host))&&this.pathSegment(t,t.ctmGroupTitle||this.url.host)}async pathSegment(e,t){let o=e.urlMatches.two_path_segment;if(o)return this.two_path_segment(o,e);let s=e.urlMatches.first_path_segment;if(s)return this.first_path_segment(s,e);await this._applyTabGroup(e,t||this.url.host)}async first_path_segment(e,t){let o=this.url.pathname.slice(1,this.url.pathname.indexOf("/",1));e.length===0&&this.applyTabGroup(t,t.ctmGroupTitle||o),e.includes(o)&&await this._applyTabGroup(t,t.ctmGroupTitle||e[0])}async two_path_segment(e,t){let o=this.url.pathname.indexOf("/",this.url.pathname.indexOf("/",1)+1),s=this.url.pathname.slice(1,o);e.length===0?this.applyTabGroup(t,t.ctmGroupTitle||s):e.includes(s)&&await this._applyTabGroup(t,t.ctmGroupTitle||e[0])}async ctm_match_pattern(e,t){if(e.length!==0){for(let o of e)if(new RegExp(o.replaceAll("*",".*")).test(this.tab.url))return await this._applyTabGroup(t,t.ctmGroupTitle||o)}}async addTabInGroup(e){this.tab=e,this.url=new URL(e.url),this.tabGroupRules??=await i();for(let t of this.tabGroupRules)if(t.enabled){if(t.titleIncludes.length!==0){for(let o of t.titleIncludes)if(e.title.includes(o))return this.applyTabGroup(this.tab.id,t,t.ctmGroupTitle||o,e.groupId)}for(let o in t.urlMatches)if(this[o])return await this[o](t.urlMatches[o],t)}}onUpdateTab(e,t,o){t.status==="complete"&&this.addTabInGroup(o)}};globalThis.getStore=chrome.storage.local.get.bind(chrome.storage.local);globalThis.setStore=chrome.storage.local.set.bind(chrome.storage.local);var G,h;chrome.runtime.onMessage.addListener((r,e,t)=>{r.msg==="toggle_auto_grouping"?(setStore({autoGroupingOn:r.autoGroupingOn}),r.autoGroupingOn?_():chrome.tabs.onUpdated.removeListener(h)):r==="group_all_ungroup_tabs"?new u().groupAllUngroupTabs():r==="reset_tab_group_rules"&&G?.()});getStore("autoGroupingOn").then(({autoGroupingOn:r})=>r&&_());function _(){f().then(r=>{let e=new u;G=e.setTabGroupRules.bind(e),h=e.onUpdateTab.bind(e),r&&chrome.tabs.onUpdated.addListener(h)})}chrome.contextMenus.onClicked.addListener(r=>g[r.menuItemId]());async function I(r){if(r==="duplicateTab"){let[e]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});chrome.tabs.duplicate(e.id).catch(t=>console.error(t))}}chrome.commands.onCommand.addListener(I);var M=({reason:r})=>{async function e(){chrome.storage.sync.set({theme:{fontSize:16,fontFamily:"",background:"none",textColor:""},workspaceOn:!0,workspaces:[],compactMode:!1});let o=crypto.randomUUID();await setStore({autoGroupingOn:!1,extUserId:o});let s=`https://uninstall-feedback.pages.dev/?e=${chrome.runtime.id}&u=${o}`;chrome.runtime.setUninstallURL(s),chrome.tabs.create({url:"guide/welcome-guide.html"}),getStore({autoGroupingOn:!1})}r==="install"&&e(),r==="update"&&t();function t(){chrome.tabs.create({url:"guide/changelog.html"}),chrome.storage.sync.set({theme:{fontSize:16,fontFamily:"",background:"none",textColor:""},workspaceOn:!0,workspaces:[],compactMode:!1})}b(),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(o=>console.error(o))};chrome.runtime.onInstalled.addListener(M);export{M as setInstallation};
